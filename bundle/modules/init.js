var v=Object.defineProperty;var c=(a,t)=>v(a,"name",{value:t,configurable:!0});var{mergeObject:S}=foundry.utils,f=class extends PlaylistDirectory{static get defaultOptions(){let t=super.defaultOptions;return t.template="modules/playlistenchantment/templates/playlists-directory.html",t}async getData(t={}){let e=await super.getData(t),n=game.settings.get("playlistenchantment","settings");return S(e,{enchantment:n,normalizeModifier:foundry.audio.AudioHelper.volumeToInput(n.normalizeModifier),normalizeTooltip:PlaylistDirectory.volumeToTooltip(n.normalizeModifier),fadeTooltip:this.fadeTooltip(n.fadeModifier)}),e}activateListeners(t){super.activateListeners(t),t.find(".enchantment-volume-slider").change(this._onEnchantmentVolume.bind(this)),t.find(".enchanment-checkbox").change(this._onEnchantmentCheckbox.bind(this)),t.find(".enchantmentcontrol").click(this._onEnchantmentControl.bind(this)),t.find(".sound").dblclick(this._onEnchantmentSound.bind(this)),t.find(".sound-name").hover(e=>{console.log(e.currentTarget.clientWidth,e.currentTarget.scrollWidth),e.currentTarget.scrollWidth>e.currentTarget.clientWidth&&(e.currentTarget.classList.add("marquee"),$(e.currentTarget).html(`<p>${e.currentTarget.textContent}</p>`))},e=>{$(e.currentTarget).html(e.currentTarget.textContent),e.currentTarget.classList.remove("marquee")})}_onEnchantmentSound(t){let e=game.playlists.get(t.currentTarget.dataset.playlistId),n=e.sounds.get(t.currentTarget.dataset.soundId);e.playSound(n)}fadeTooltip(t){return game.i18n.format("PLAYLISTENCHANTMENT.FadeTooltip",{value:t})}_onEnchantmentVolume(t){t.preventDefault();let e=t.currentTarget,n,s;return t.currentTarget.dataset.volume?(n=foundry.audio.AudioHelper.inputToVolume(e.value),s=PlaylistDirectory.volumeToTooltip(n)):t.currentTarget.dataset.unit&&(n=e.value,s=this.fadeTooltip(e.value)),e.setAttribute("data-tooltip",s),game.tooltip.activate(e,{text:s}),this.updatePlaylistEnchantment({[t.currentTarget.name]:n})}_onEnchantmentControl(t){let e=t.currentTarget.dataset.action;switch(e){case"play":this._enchantStartAll(t);break;case"stop":this._enchantStopAll();break;case"playlist-forward":case"playlist-backward":this._enchantAllSkip(e);break}}static async hotbarPlaylist(t){this.crossFade(t)}static async crossFade(t){let e=game.settings.get("playlistenchantment","settings"),n=e.fadeModifier,s=await fromUuid(t),o,i;if(s instanceof Playlist)o=s;else if(s instanceof PlaylistSound)i=s,o=i.parent;else if(s instanceof Folder){let r=s.contents;o=r[Math.floor(Math.random()*r.length)]}else return;let u=c(async(r,p,m)=>{m?await r.playSound(m):await r.playAll();let d=m||r.sounds.find(h=>h.playing);e.normalize&&d.updateSource({volume:e.normalizeModifier||.5});let g=d.volume||.5;d.sound.fade(g,{duration:p,from:0})},"fadeIn"),l=c((r,p,m=!0)=>{if(!r.playing)return;let d=r.sounds.find(h=>h.playing).sound;if(!d)return;let g=d.volume;d.fade(0,{duration:p,from:g}),m&&setTimeout(()=>r.stopAll(),p)},"fadeOut");if(!o){ui.notifications.error("Can't start Playlist - not found");return}if(!(!i&&ui.playlists._playingPlaylists.find(r=>r.id==o.id))){for(let r of ui.playlists._playingPlaylists)l(r,n,r.id!=o.id);u(o,n,i)}}_updateTimestamps(){super._updateTimestamps();for(let t of this._playingSounds){let e=$(".enchantmentplaylisttooltip")[0]?.querySelector(`.sound[data-sound-id="${t.id}"]`);if(!e)continue;let n=e.querySelector("span.current"),s=t.playing?t.sound.currentTime:t.pausedTime;n&&(n.textContent=this._formatTimestamp(s));let o=e.querySelector("span.duration");o&&(o.textContent=this._formatTimestamp(t.sound.duration));let i=e.querySelector("a.pause");i.classList.contains("fa-spinner")&&(i.classList.remove("fa-spin"),i.classList.replace("fa-spinner","fa-pause"))}}async _enchantStartAll(t){for(let e of this._playingSounds){let n=e.parent;n.mode>=0&&n.playSound(e)}if(this._playingSounds.length===0){let e=$(t.currentTarget).closest("[data-macro-id]")[0]?.dataset.macroId;e&&game.macros.get(e)?.execute()}}async _enchantAllSkip(t){for(let e of this._playingPlaylists)e.mode>=0&&e.playNext(void 0,{direction:t==="playlist-forward"?1:-1})}async _enchantStopAll(){for(let t of this._playingSounds)t.update({playing:!1,pausedTime:t.sound.currentTime})}async updatePlaylistEnchantment(t){let e=game.settings.get("playlistenchantment","settings");return S(e,t),await game.settings.set("playlistenchantment","settings",e)}_onEnchantmentCheckbox(t){let e={[t.currentTarget.name]:t.currentTarget.checked};return this.updatePlaylistEnchantment(e)}};c(f,"EnchantedPlaylist");var{mergeObject:I,getProperty:M}=foundry.utils;function b(){Hooks.on("hotbarDrop",(a,t,e)=>{if(["PlaylistSound","Playlist"].includes(t.type))return _(t.uuid,e),!1;if(t.type=="Folder"&&fromUuidSync(t.uuid).type=="Playlist")return _(t.uuid,e),!1}),Hooks.on("getEnchantedPlaylistSoundContext",(a,t)=>{t.push({name:"PLAYLISTENCHANTMENT.Prehear",icon:"<i class='fas fa-music'></i>",callback:e=>k(e)})}),Hooks.on("renderHotbar",(a,t)=>{let e=t.find(".macro.active");e.mouseenter(n=>P(n)),e.mouseleave(n=>T(n)),e.mousedown(n=>T(n))}),Hooks.on("preUpdatePlaylist",(a,t,e,n)=>{if(a.mode>=0&&"sounds"in t){let s={},o=game.settings.get("playlistenchantment","settings");if(o.alwaysFade&&(s.fade=o.fadeModifier||0),o.normalize){let i=t.sounds.find(u=>u.playing);if(!i)return;i.volume=o.normalizeModifier||0,s.sounds=[i]}Object.keys(s).length>0&&a.updateSource(s)}})}c(b,"setupHooks");async function _(a,t){let e=await fromUuid(a),n=`CONFIG.ui.playlists.hotbarPlaylist("${a}")`;w(n,e.name,"icons/svg/sound.svg",t,"Playlist")}c(_,"buildPlaylistMacro");function P(a){let t=game.macros.get(a.currentTarget.dataset.macroId);!t||!M(t,"flags.enchantedplaylist.type")||H(a)}c(P,"onHoverMacros");async function k(a){let t=a[0].dataset.playlistId,e=a[0].dataset.soundId,n=game.playlists.get(t).sounds.get(e),s=game.settings.get("playlistenchantment","settings"),o=s.normalize?s.normalizeModifier:n.volume||.5;ui.notifications.info(`Fetching & Playing ${n.name}`),foundry.audio.AudioHelper.play({src:n.path,volume:o,loop:!1},!1).then(i=>{new y(i,n).render(!0)})}c(k,"preHearSound");var y=class extends Application{static get defaultOptions(){return I(super.defaultOptions,{template:"modules/playlistenchantment/templates/soundpreview.html"})}constructor(t,e){super(),this.sound=t,this.source=e,this.sound.addEventListener("stop",()=>{this.close()}),this.sound.addEventListener("end",()=>{this.close()})}async getData(){let t=await super.getData();return t.sound=this.sound,t.source=this.source,t}activateListeners(t){t.find(".stopSound").click(()=>this.close())}async close(t){return this.sound.stop(),super.close(t)}};c(y,"SoundPreview");async function H(a){let t=".enchantmentplaylisttooltip";$(t).remove();let e=a.currentTarget.getBoundingClientRect(),n=a.currentTarget.dataset.tooltip,s=foundry.utils.duplicate(ui.playlists._playingSoundsData);for(let l of s){let r=ui.playlists._playingSounds.find(p=>p._id==l._id);l.pauseIcon=ui.playlists._getPauseIcon(r),l.lvolume=foundry.audio.AudioHelper.volumeToInput(l.volume),l.volumeTooltip=ui.playlists.constructor.volumeToTooltip(l.volume),l.currentTime=ui.playlists._formatTimestamp(r.playing?r.sound.currentTime:l.pausedTime),l.durationTime=ui.playlists._formatTimestamp(r.sound.duration)}let o={macroId:a.currentTarget.dataset.macroId,name:n,isGM:game.user.isGM,playingSounds:s,showPlaying:ui.playlists._playingSoundsData.length>0},i=$(await renderTemplate("modules/playlistenchantment/templates/currentplayling.html",o));ui.playlists.activateListeners(i),$("body").append(i);let u=$(`.enchantmentplaylisttooltip[data-macro-id="${a.currentTarget.dataset.macroId}"]`);u.on("mouseleave",l=>T(l)),u.css({left:e.x-125+e.width/2,top:e.y-u.height(),zIndex:1e3}),u.fadeIn(),game.tooltip.deactivate()}c(H,"showHotbarSoundMenu");function T(a){let t=`.enchantmentplaylisttooltip[data-macro-id="${a.currentTarget.dataset.macroId}"]`;setTimeout(()=>{$(`${t}:hover`).length||$(t).remove()},100)}c(T,"onUnhoverMacros");function w(a,t,e,n,s){let o=game.macros.contents.find(i=>i.name===t&&i.command===a);return o?game.user.assignHotbarMacro(o,n):Macro.create({name:t,type:"script",img:e,command:a,flags:{enchantedplaylist:{type:s}}},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,n)),!1}c(w,"createHotBarMacro");Hooks.once("init",()=>{game.settings.register("playlistenchantment","settings",{name:"playlistsettings",scope:"world",config:!1,default:{normalize:!1,normalizeModifier:.5,fadeModifier:500,alwaysFade:!1},type:Object}),CONFIG.ui.playlists=f});Hooks.once("setup",()=>{b()});
