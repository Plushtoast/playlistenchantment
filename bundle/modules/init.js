var S=Object.defineProperty;var r=(a,t)=>S(a,"name",{value:t,configurable:!0});var p=class extends PlaylistDirectory{static get defaultOptions(){let t=super.defaultOptions;return t.template="modules/playlistenchantment/templates/playlists-directory.html",t}async getData(t={}){let e=await super.getData(t),n=game.settings.get("playlistenchantment","settings");return mergeObject(e,{enchantment:n,normalizeModifier:AudioHelper.volumeToInput(n.normalizeModifier),normalizeTooltip:PlaylistDirectory.volumeToTooltip(n.normalizeModifier),fadeTooltip:this.fadeTooltip(n.fadeModifier)}),e}activateListeners(t){super.activateListeners(t),t.find(".enchantment-volume-slider").change(this._onEnchantmentVolume.bind(this)),t.find(".enchanment-checkbox").change(this._onEnchantmentCheckbox.bind(this)),t.find(".enchantmentcontrol").click(this._onEnchantmentControl.bind(this)),t.find(".sound").dblclick(this._onEnchantmentSound.bind(this))}_onEnchantmentSound(t){let e=game.playlists.get(t.currentTarget.dataset.playlistId),n=e.sounds.get(t.currentTarget.dataset.soundId);e.playSound(n)}fadeTooltip(t){return game.i18n.format("PLAYLISTENCHANTMENT.FadeTooltip",{value:t})}_onEnchantmentVolume(t){t.preventDefault();let e=t.currentTarget,n,s;return t.currentTarget.dataset.volume?(n=AudioHelper.inputToVolume(e.value),s=PlaylistDirectory.volumeToTooltip(n)):t.currentTarget.dataset.unit&&(n=e.value,s=this.fadeTooltip(e.value)),e.setAttribute("data-tooltip",s),game.tooltip.activate(e,{text:s}),this.updatePlaylistEnchantment({[t.currentTarget.name]:n})}_onEnchantmentControl(t){let e=t.currentTarget.dataset.action;switch(e){case"play":this._enchantStartAll();break;case"stop":this._enchantStopAll();break;case"playlist-forward":case"playlist-backward":this._enchantAllSkip(e);break}}static async hotbarPlaylist(t){this.crossFade(t)}static async crossFade(t){let e=game.settings.get("playlistenchantment","settings"),n=e.fadeModifier,s=await fromUuid(t),o,i;if(s instanceof Playlist)o=s;else if(s instanceof PlaylistSound)i=s,o=i.parent;else if(s instanceof Folder){let l=s.contents;o=l[Math.floor(Math.random()*l.length)]}else return;let d=r(async(l,m,u)=>{u?await l.playSound(u):await l.playAll();let c=u||l.sounds.find(g=>g.playing);e.normalize&&c.updateSource({volume:e.normalizeModifier||.5});let y=c.effectiveVolume||.5;c.sound.fade(y,{duration:m,from:0})},"fadeIn"),M=r((l,m,u=!0)=>{if(!l.playing)return;let c=l.sounds.find(g=>g.playing).sound;if(!c)return;let y=c.volume;c.fade(0,{duration:m,from:y}),u&&setTimeout(()=>l.stopAll(),m)},"fadeOut");if(!o){ui.notifications.error("Can't start Playlist - not found");return}if(!(!i&&ui.playlists._playingPlaylists.find(l=>l.id==o.id))){for(let l of ui.playlists._playingPlaylists)M(l,n,l.id!=o.id);d(o,n,i)}}async _enchantStartAll(){for(let t of this._playingSounds){let e=t.parent;e.mode>=0&&e.playSound(t)}}async _enchantAllSkip(t){for(let e of this._playingPlaylists)e.mode>=0&&e.playNext(void 0,{direction:t==="playlist-forward"?1:-1})}async _enchantStopAll(){for(let t of this._playingSounds)t.update({playing:!1,pausedTime:t.sound.currentTime})}async updatePlaylistEnchantment(t){let e=game.settings.get("playlistenchantment","settings");return mergeObject(e,t),await game.settings.set("playlistenchantment","settings",e)}_onEnchantmentCheckbox(t){let e={[t.currentTarget.name]:t.currentTarget.checked};return this.updatePlaylistEnchantment(e)}};r(p,"EnchantedPlaylist");function b(){Hooks.on("hotbarDrop",(a,t,e)=>{if(["PlaylistSound","Playlist"].includes(t.type))return T(t.uuid,e),!1;if(t.type=="Folder"&&fromUuidSync(t.uuid).type=="Playlist")return T(t.uuid,e),!1}),Hooks.on("getEnchantedPlaylistSoundContext",(a,t)=>{t.push({name:"PLAYLISTENCHANTMENT.Prehear",icon:"<i class='fas fa-music'></i>",callback:e=>P(e)})}),Hooks.on("renderHotbar",(a,t)=>{let e=t.find(".macro.active");e.mouseenter(n=>v(n)),e.mouseleave(n=>h(n)),e.mousedown(n=>h(n))}),Hooks.on("preUpdatePlaylist",(a,t,e,n)=>{if(a.playing&&a.mode>=0&&"sounds"in t){let s={},o=game.settings.get("playlistenchantment","settings");if(o.alwaysFade&&(s.fade=o.fadeModifier||0),o.normalize){let i=t.sounds.find(d=>d.playing);if(!i)return;i.volume=o.normalizeModifier||0,s.sounds=[i]}Object.keys(s).length>0&&a.updateSource(s)}})}r(b,"setupHooks");async function T(a,t){let e=await fromUuid(a),n=`CONFIG.ui.playlists.hotbarPlaylist("${a}")`;_(n,e.name,"icons/svg/sound.svg",t,"Playlist")}r(T,"buildPlaylistMacro");function v(a){let t=game.macros.get(a.currentTarget.dataset.macroId);!t||!getProperty(t,"flags.enchantedplaylist.type")||k(a)}r(v,"onHoverMacros");async function P(a){let t=a[0].dataset.playlistId,e=a[0].dataset.soundId,n=game.playlists.get(t).sounds.get(e),s=game.settings.get("playlistenchantment","settings"),o=s.normalize?s.normalizeModifier:n.volume||.5;ui.notifications.info(`Fetching & Playing ${n.name}`),AudioHelper.play({src:n.sound.src,volume:o,loop:!1},!1).then(i=>{new f(i,n).render(!0)})}r(P,"preHearSound");var f=class extends Application{static get defaultOptions(){return mergeObject(super.defaultOptions,{template:"modules/playlistenchantment/templates/soundpreview.html"})}constructor(t,e){super(),this.sound=t,this.source=e,this.sound.on("stop",()=>{this.close()}),this.sound.on("end",()=>{this.close()})}async getData(){let t=await super.getData();return t.sound=this.sound,t.source=this.source,t}activateListeners(t){t.find(".stopSound").click(e=>this.close())}async close(t){return this.sound.stop(),super.close(t)}};r(f,"SoundPreview");async function k(a){let t=".enchantmentplaylisttooltip";$(t).remove();let e=a.currentTarget.getBoundingClientRect(),n=a.currentTarget.dataset.tooltip,s={macroId:a.currentTarget.dataset.macroId,name:n,isGM:game.user.isGM,playingSounds:ui.playlists._playingSoundsData,showPlaying:ui.playlists._playingSoundsData.length>0},o=$(await renderTemplate("modules/playlistenchantment/templates/currentplayling.html",s));ui.playlists.activateListeners(o),$("body").append(o);let i=$(`.enchantmentplaylisttooltip[data-macro-id="${a.currentTarget.dataset.macroId}"]`);i.mouseleave(d=>h(d)),i.css({left:e.x-125+e.width/2,top:e.y-i.height(),zIndex:1e3}),i.fadeIn(),game.tooltip.deactivate()}r(k,"showHotbarSoundMenu");function h(a){let t=`.enchantmentplaylisttooltip[data-macro-id="${a.currentTarget.dataset.macroId}"]`;setTimeout(()=>{$(`${t}:hover`).length||$(t).remove()},100)}r(h,"onUnhoverMacros");function _(a,t,e,n,s){let o=game.macros.contents.find(i=>i.name===t&&i.command===a);return o?game.user.assignHotbarMacro(o,n):Macro.create({name:t,type:"script",img:e,command:a,flags:{enchantedplaylist:{type:s}}},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,n)),!1}r(_,"createHotBarMacro");Hooks.once("init",()=>{game.settings.register("playlistenchantment","settings",{name:"playlistsettings",scope:"world",config:!1,default:{normalize:!1,normalizeModifier:.5,fadeModifier:500,alwaysFade:!1},type:Object}),CONFIG.ui.playlists=p});Hooks.once("setup",()=>{!game.user.isGM||b()});
