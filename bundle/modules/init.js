var I=Object.defineProperty;var _=Object.getPrototypeOf;var M=Reflect.get;var k=(a,t,e)=>t in a?I(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var p=(a,t)=>I(a,"name",{value:t,configurable:!0});var T=(a,t,e)=>(k(a,typeof t!="symbol"?t+"":t,e),e);var b=(a,t,e)=>M(_(a),e,t);var{mergeObject:F}=foundry.utils,{PlaylistDirectory:L}=foundry.applications.sidebar.tabs,y=class extends L{async _prepareContext(t){let e=await super._prepareContext(t),n=game.settings.get("playlistenchantment","settings"),s=foundry.audio.AudioHelper.volumeToInput(n.normalizeModifier);return F(e,{enchantment:n,normalizeModifier:s,normalizeTooltip:foundry.audio.AudioHelper.volumeToPercentage(s),fadeTooltip:this.fadeTooltip(n.fadeModifier)}),e}async _onRender(t,e){await super._onRender(t,e),this.activateListeners($(this.element))}activateListeners(t){t.find(".enchantment-volume-slider").change(this._onEnchantmentVolume.bind(this)),t.find(".enchanment-checkbox").change(this._onEnchantmentCheckbox.bind(this)),t.find(".enchantmentcontrol").click(this._onEnchantmentControl.bind(this)),t.find(".sound").dblclick(this._onEnchantmentSound.bind(this)),t.find(".sound .soundName").hover(e=>{e.currentTarget.scrollWidth>e.currentTarget.clientWidth&&e.currentTarget.classList.add("marquee")},e=>{e.currentTarget.classList.remove("marquee")})}_onEnchantmentSound(t){let e=game.playlists.get(t.currentTarget.dataset.playlistId),n=e.sounds.get(t.currentTarget.dataset.soundId);e.playSound(n)}fadeTooltip(t){return game.i18n.format("PLAYLISTENCHANTMENT.FadeTooltip",{value:t})}_onEnchantmentVolume(t){t.preventDefault();let e=t.currentTarget,n,s;return t.currentTarget.dataset.volume?(n=foundry.audio.AudioHelper.inputToVolume(e.value),s=foundry.audio.AudioHelper.volumeToPercentage(n)):t.currentTarget.dataset.unit&&(n=e.value,s=this.fadeTooltip(e.value)),e.setAttribute("data-tooltip",s),game.tooltip.activate(e,{text:s}),this.updatePlaylistEnchantment({[t.currentTarget.name]:n})}_onEnchantmentControl(t){let e=t.currentTarget.dataset.action;switch(e){case"play":this._enchantStartAll(t);break;case"stop":this._enchantStopAll();break;case"playlist-forward":case"playlist-backward":this._enchantAllSkip(e);break}}static async hotbarPlaylist(t){this.crossFade(t)}static async crossFade(t){let e=game.settings.get("playlistenchantment","settings"),n=e.fadeModifier,s=await fromUuid(t),o,r;if(s instanceof Playlist)o=s;else if(s instanceof PlaylistSound)r=s,o=r.parent;else if(s instanceof Folder){let i=s.contents;o=i[Math.floor(Math.random()*i.length)]}else return;let c=p(async(i,l,u)=>{u?await i.playSound(u):await i.playAll();let d=u||i.sounds.find(f=>f.playing);e.normalize&&d.updateSource({volume:e.normalizeModifier||.5});let g=d.volume||.5;d.sound.fade(g,{duration:l,from:0})},"fadeIn"),m=p((i,l,u=!0)=>{if(!i.playing)return;let d=i.sounds.find(f=>f.playing).sound;if(!d)return;let g=d.volume;d.fade(0,{duration:l,from:g}),u&&setTimeout(()=>i.stopAll(),l)},"fadeOut");if(!o){ui.notifications.error("Can't start Playlist - not found");return}if(!(!r&&ui.playlists.playing.find(i=>i.id==o.id))){for(let i of ui.playlists.playing)m(i,n,i.id!=o.id);c(o,n,r)}}_updateTimestamps(){super._updateTimestamps();for(let t of this._playing.sounds){let e=$(".enchantmentplaylisttooltip")[0]?.querySelector(`.sound[data-sound-id="${t.id}"]`);if(!e)continue;let n=e.querySelector("span.current"),s=t.playing?t.sound.currentTime:t.pausedTime;n&&(n.textContent=this._formatTimestamp(s));let o=e.querySelector("span.duration");o&&(o.textContent=this._formatTimestamp(t.sound.duration));let r=e.querySelector("a.pause");r.classList.contains("fa-spinner")&&(r.classList.remove("fa-spin"),r.classList.replace("fa-spinner","fa-pause"))}}async _enchantStartAll(t){for(let e of this._playing.sounds){let n=e.parent;n.mode>=0&&n.playSound(e)}if(this._playing.sounds.length===0){let e=$(t.currentTarget).closest("[data-macro-id]")[0]?.dataset.macroId;e&&game.macros.get(e)?.execute()}}async _enchantAllSkip(t){for(let e of this.playing)e.mode>=0&&e.playNext(void 0,{direction:t==="playlist-forward"?1:-1})}async _enchantStopAll(){for(let t of this._playing.sounds)t.update({playing:!1,pausedTime:t.sound.currentTime})}async updatePlaylistEnchantment(t){let e=game.settings.get("playlistenchantment","settings");return F(e,t),await game.settings.set("playlistenchantment","settings",e)}_onEnchantmentCheckbox(t){let e={[t.currentTarget.name]:t.currentTarget.checked};return this.updatePlaylistEnchantment(e)}async _onDrop(t){t.preventDefault();let e=t.dataTransfer.files;if(e&&e.length>0){let n=Array.from(e).filter(s=>Object.keys(CONST.AUDIO_FILE_EXTENSIONS).includes(s.name.split(".").pop()));await this.handleAudioFilesUpload(t,n)}else super._onDrop(t)}isForge(){return typeof ForgeVTT<"u"&&ForgeVTT&&ForgeVTT.usingTheForge}findFilePicker(){return this.isForge()?ForgeVTT_FilePicker:foundry.applications.apps.FilePicker.implementation}async handleAudioFilesUpload(t,e){let n=game.settings.get("playlistenchantment","soundUploadFolder"),s=this.findFilePicker(),o=[];for(let m of e){let i=ui.notifications.info(game.i18n.format("PLAYLISTENCHANTMENT.uploading",{item:m.name}),{permanent:!0}),l=await s.upload("data",n,m);ui.notifications.remove(i);let u=m.name.split(".").slice(0,-1).join(".");o.push({name:u,path:l.path})}let r=this.getPlaylistIdFromElement(t.srcElement.closest(".playlist")),c=game.playlists.get(r);c||(c=game.playlists.find(m=>m.name===y.defaultUploadPlaylistName)),c||(c=await Playlist.create({name:y.defaultUploadPlaylistName,description:"Files uploaded by drag and drop",playing:!1})),c.createEmbeddedDocuments("PlaylistSound",o),ui.notifications.info(game.i18n.localize("PLAYLISTENCHANTMENT.uploadDone"))}getPlaylistIdFromElement(t){if(t==null)return!1;let e=t.classList.contains("playlist")?t:t.closest(".playlist");return e?e.dataset.entryId:(ui.notifications.error(game.i18n.localize("PLAYLISTENCHANTMENT.errorNoPlaylist")),!1)}},h=y;p(h,"EnchantedPlaylist"),T(h,"_entryPartial","modules/playlistenchantment/templates/playlist/playlist-partial.hbs"),T(h,"PARTS",{header:b(y,y,"PARTS").header,controls:{template:"modules/playlistenchantment/templates/playlist/controls.hbs"},directory:b(y,y,"PARTS").directory,playing:{template:"modules/playlistenchantment/templates/playlist/playing.hbs",templates:["modules/playlistenchantment/templates/playlist/sound-partial.hbs"]},footer:b(y,y,"PARTS").footer}),T(h,"defaultUploadPlaylistName","Playlistenchantment - Uploads");var{mergeObject:V,getProperty:E}=foundry.utils;function H(){Hooks.on("hotbarDrop",(a,t,e)=>{if(["PlaylistSound","Playlist"].includes(t.type))return v(t.uuid,e),!1;if(t.type=="Folder"&&fromUuidSync(t.uuid).type=="Playlist")return v(t.uuid,e),!1}),Hooks.on("getPlaylistSoundContextOptions",(a,t)=>{t.push({name:"PLAYLISTENCHANTMENT.Prehear",icon:"<i class='fas fa-music'></i>",callback:e=>x(e)})}),Hooks.on("renderHotbar",(a,t)=>{t=$(t);let e=t.find(".slot.full");e.mouseenter(n=>w(n)),e.mouseleave(n=>P(n)),e.mousedown(n=>P(n))}),Hooks.on("preUpdatePlaylist",(a,t,e,n)=>{if(a.mode>=0&&"sounds"in t){let s={},o=game.settings.get("playlistenchantment","settings");if(o.alwaysFade&&(s.fade=o.fadeModifier||0),o.normalize){let r=t.sounds.find(c=>c.playing);if(!r)return;r.volume=o.normalizeModifier||0,s.sounds=[r]}Object.keys(s).length>0&&a.updateSource(s)}})}p(H,"setupHooks");async function v(a,t){let e=await fromUuid(a),n=`CONFIG.ui.playlists.hotbarPlaylist("${a}")`;U(n,e.name,"icons/svg/sound.svg",t,"Playlist")}p(v,"buildPlaylistMacro");function w(a){let t=a.currentTarget.dataset.slot,e=game.user.hotbar[t];if(!e)return;let n=game.macros.get(e);!n||!E(n,"flags.enchantedplaylist.type")||C(a,e)}p(w,"onHoverMacros");async function x(a){let t=a.dataset.playlistId,e=a.dataset.soundId,n=game.playlists.get(t).sounds.get(e),s=game.settings.get("playlistenchantment","settings"),o=s.normalize?s.normalizeModifier:n.volume||.5;ui.notifications.info(`Fetching & Playing ${n.name}`),foundry.audio.AudioHelper.play({src:n.path,volume:o,loop:!1},!1).then(r=>{new S(r,n).render(!0)})}p(x,"preHearSound");var N=class extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(t,e){super(),this.sound=t,this.source=e,this.sound.addEventListener("stop",()=>{this.close()}),this.sound.addEventListener("end",()=>{this.close()})}async _prepareContext(t){let e=await super._prepareContext(t);return e.sound=this.sound,e.source=this.source,e}static _stopSound(t,e){this.close()}async close(t){return this.sound.stop(),super.close(t)}},S=N;p(S,"SoundPreview"),T(S,"PARTS",{main:{template:"modules/playlistenchantment/templates/soundpreview.hbs"}}),T(S,"DEFAULT_OPTIONS",{window:{title:"PLAYLISTENCHANTMENT.Prehear"},actions:{stopSound:N._stopSound}});async function C(a,t){let e=".enchantmentplaylisttooltip";$(e).remove();let n=a.currentTarget.getBoundingClientRect(),s=a.currentTarget.dataset.tooltipText,o=[];for(let i of ui.playlists._playing.context){let l=foundry.utils.duplicate(i),u=ui.playlists._playing.sounds.find(g=>g._id==l.id),d=foundry.audio.AudioHelper.volumeToInput(l.volume);l.pause.icon=`fa-solid ${u.playing&&!u.sound?.loaded?"fa-spinner fa-spin":"fa-pause"}`,l.lvolume=d,l.volumeTooltip=foundry.audio.AudioHelper.volumeToPercentage(d),l.currentTime=ui.playlists.constructor.formatTimestamp(u.playing?u.sound.currentTime:l.pausedTime),l.durationTime=ui.playlists.constructor.formatTimestamp(u.sound.duration),l.volume=i.volume,o.push(l)}let r={macroId:t,name:s,isGM:game.user.isGM,playingSounds:o,showPlaying:ui.playlists.playing.length>0},c=$(await foundry.applications.handlebars.renderTemplate("modules/playlistenchantment/templates/currentplayling.hbs",r));ui.playlists.activateListeners(c),c.find("[data-action]").on("click",i=>{let l=i.currentTarget;if(l.dataset.action==="soundRepeat"){let{playlistId:d,soundId:g}=l.closest(".sound")?.dataset??{},f=game.playlists.get(d)?.sounds.get(g);return f?.update({repeat:!f?.repeat})}else{let{playlistId:d,soundId:g}=l.closest(".sound")?.dataset??{},f=game.playlists.get(d),A=f?.sounds.get(g);switch(l.dataset.action){case"soundPause":return A.update({playing:!1,pausedTime:A.sound.currentTime});case"soundPlay":return f.playSound(A);case"soundStop":return f.stopSound(A)}}}),c.find(".sound-volume").on("input",i=>{let l=i.currentTarget;ui.playlists._onSoundVolume(l),setTimeout(()=>{ui.playlists.render()},120)}),$("body").append(c);let m=$(`.enchantmentplaylisttooltip[data-macro-id="${t}"]`);m.on("mouseleave",i=>P(t)),m.css({left:n.x-125+n.width/2,top:n.y-m.height(),zIndex:1e3}),m.fadeIn(),game.tooltip.deactivate()}p(C,"showHotbarSoundMenu");function P(a){let t=`.enchantmentplaylisttooltip[data-macro-id="${a}"]`;setTimeout(()=>{$(`${t}:hover`).length||$(t).remove()},100)}p(P,"onUnhoverMacros");function U(a,t,e,n,s){let o=game.macros.contents.find(r=>r.name===t&&r.command===a);return o?game.user.assignHotbarMacro(o,n):Macro.create({name:t,type:"script",img:e,command:a,flags:{enchantedplaylist:{type:s}}},{displaySheet:!1}).then(r=>game.user.assignHotbarMacro(r,n)),!1}p(U,"createHotBarMacro");Hooks.once("init",()=>{game.settings.register("playlistenchantment","settings",{name:"playlistsettings",scope:"world",config:!1,default:{normalize:!1,normalizeModifier:.5,fadeModifier:500,alwaysFade:!1},type:Object}),game.settings.register("playlistenchantment","soundUploadFolder",{name:"PLAYLISTENCHANTMENT.soundUploadFolder",hint:"PLAYLISTENCHANTMENT.soundUploadFolderHint",scope:"world",config:!0,type:String,filePicker:"folder",default:"modules/playlistenchantment/storage"}),CONFIG.ui.playlists=h});Hooks.once("setup",()=>{H()});
