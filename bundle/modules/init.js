var N=Object.defineProperty;var w=Object.getPrototypeOf;var _=Reflect.get;var M=(o,t,e)=>t in o?N(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var c=(o,t)=>N(o,"name",{value:t,configurable:!0});var f=(o,t,e)=>(M(o,typeof t!="symbol"?t+"":t,e),e);var A=(o,t,e)=>_(w(o),e,t);var{mergeObject:F}=foundry.utils,{PlaylistDirectory:L}=foundry.applications.sidebar.tabs,d=class extends L{async _prepareContext(t){let e=await super._prepareContext(t),s=game.settings.get("playlistenchantment","settings"),n=foundry.audio.AudioHelper.volumeToInput(s.normalizeModifier);return F(e,{enchantment:s,normalizeModifier:n,normalizeTooltip:foundry.audio.AudioHelper.volumeToPercentage(n),fadeTooltip:this.fadeTooltip(s.fadeModifier)}),e}async _onRender(t,e){await super._onRender(t,e),this.activateListeners($(this.element))}activateListeners(t){t.find(".enchantment-volume-slider").change(this._onEnchantmentVolume.bind(this)),t.find(".enchanment-checkbox").change(this._onEnchantmentCheckbox.bind(this)),t.find(".sound").dblclick(this._onEnchantmentSound.bind(this)),t.find(".sound .soundName").hover(e=>{e.currentTarget.scrollWidth>e.currentTarget.clientWidth&&e.currentTarget.classList.add("marquee")},e=>{e.currentTarget.classList.remove("marquee")})}_onEnchantmentSound(t){let e=game.playlists.get(t.currentTarget.dataset.playlistId),s=e.sounds.get(t.currentTarget.dataset.soundId);e.playSound(s)}fadeTooltip(t){return game.i18n.format("PLAYLISTENCHANTMENT.FadeTooltip",{value:t})}_onEnchantmentVolume(t){t.preventDefault();let e=t.currentTarget,s,n;return t.currentTarget.dataset.volume?(s=foundry.audio.AudioHelper.inputToVolume(e.value),n=foundry.audio.AudioHelper.volumeToPercentage(s)):t.currentTarget.dataset.unit&&(s=e.value,n=this.fadeTooltip(e.value)),e.setAttribute("data-tooltip",n),game.tooltip.activate(e,{text:n}),this.updatePlaylistEnchantment({[t.currentTarget.name]:s})}static async hotbarPlaylist(t){this.crossFade(t)}static async crossFade(t){let e=game.settings.get("playlistenchantment","settings"),s=e.fadeModifier,n=await fromUuid(t),a,i;if(n instanceof Playlist)a=n;else if(n instanceof PlaylistSound)i=n,a=i.parent;else if(n instanceof Folder){let l=n.contents;a=l[Math.floor(Math.random()*l.length)]}else return;let r=c(async(l,m,u)=>{u?await l.playSound(u):await l.playAll();let y=u||l.sounds.find(P=>P.playing);e.normalize&&y.updateSource({volume:e.normalizeModifier||.5});let b=y.volume||.5;y.sound.fade(b,{duration:m,from:0})},"fadeIn"),p=c((l,m,u=!0)=>{if(!l.playing)return;let y=l.sounds.find(P=>P.playing).sound;if(!y)return;let b=y.volume;y.fade(0,{duration:m,from:b}),u&&setTimeout(()=>l.stopAll(),m)},"fadeOut");if(!a){ui.notifications.error("Can't start Playlist - not found");return}if(!(!i&&ui.playlists.playing.find(l=>l.id==a.id))){for(let l of ui.playlists.playing)p(l,s,l.id!=a.id);r(a,s,i)}}_updateTimestamps(){super._updateTimestamps();for(let t of this._playing.sounds){let e=$(".enchantmentplaylisttooltip")[0]?.querySelector(`.sound[data-sound-id="${t.id}"]`);if(!e)continue;let s=e.querySelector("span.current"),n=t.playing?t.sound.currentTime:t.pausedTime;s&&(s.textContent=this._formatTimestamp(n));let a=e.querySelector("span.duration");a&&(a.textContent=this._formatTimestamp(t.sound.duration));let i=e.querySelector("a.pause");i.classList.contains("fa-spinner")&&(i.classList.remove("fa-spin"),i.classList.replace("fa-spinner","fa-pause"))}}static async _enchantStartAll(t,e){for(let s of this._playing.sounds){let n=s.parent;n.mode>=0&&n.playSound(s)}if(this._playing.sounds.length===0){let s=$(e).closest("[data-macro-id]")[0]?.dataset.macroId;s&&game.macros.get(s)?.execute()}}static async _enchantAllSkip(t,e){let s=e.dataset.action;for(let n of this.playing)n.mode>=0&&n.playNext(null,{direction:s==="enchPlaylistForward"?1:-1})}static async _enchantStopAll(t,e){for(let s of this._playing.sounds)s.update({playing:!1,pausedTime:s.sound.currentTime})}async updatePlaylistEnchantment(t){let e=game.settings.get("playlistenchantment","settings");return F(e,t),await game.settings.set("playlistenchantment","settings",e)}_onEnchantmentCheckbox(t){let e={[t.currentTarget.name]:t.currentTarget.checked};return this.updatePlaylistEnchantment(e)}async _onDrop(t){t.preventDefault();let e=t.dataTransfer.files;if(e&&e.length>0){let s=Array.from(e).filter(n=>Object.keys(CONST.AUDIO_FILE_EXTENSIONS).includes(n.name.split(".").pop()));await this.handleAudioFilesUpload(t,s)}else super._onDrop(t)}isForge(){return typeof ForgeVTT<"u"&&ForgeVTT&&ForgeVTT.usingTheForge}findFilePicker(){return this.isForge()?ForgeVTT_FilePicker:foundry.applications.apps.FilePicker.implementation}async handleAudioFilesUpload(t,e){let s=game.settings.get("playlistenchantment","soundUploadFolder"),n=this.findFilePicker(),a=[];for(let p of e){let l=ui.notifications.info(game.i18n.format("PLAYLISTENCHANTMENT.uploading",{item:p.name}),{permanent:!0}),m=await n.upload("data",s,p);ui.notifications.remove(l);let u=p.name.split(".").slice(0,-1).join(".");a.push({name:u,path:m.path})}let i=this.getPlaylistIdFromElement(t.srcElement.closest(".playlist")),r=game.playlists.get(i);r||(r=game.playlists.find(p=>p.name===d.defaultUploadPlaylistName)),r||(r=await Playlist.create({name:d.defaultUploadPlaylistName,description:"Files uploaded by drag and drop",playing:!1})),r.createEmbeddedDocuments("PlaylistSound",a),ui.notifications.info(game.i18n.localize("PLAYLISTENCHANTMENT.uploadDone"))}getPlaylistIdFromElement(t){if(t==null)return!1;let e=t.classList.contains("playlist")?t:t.closest(".playlist");return e?e.dataset.entryId:(ui.notifications.error(game.i18n.localize("PLAYLISTENCHANTMENT.errorNoPlaylist")),!1)}},g=d;c(g,"EnchantedPlaylist"),f(g,"DEFAULT_OPTIONS",{actions:{enchPlaylistBackward:d._enchantAllSkip,enchPlaylistForward:d._enchantAllSkip,enchPlay:d._enchantStartAll,enchStop:d._enchantStopAll}}),f(g,"_entryPartial","modules/playlistenchantment/templates/playlist/playlist-partial.hbs"),f(g,"PARTS",{header:A(d,d,"PARTS").header,controls:{template:"modules/playlistenchantment/templates/playlist/controls.hbs"},directory:A(d,d,"PARTS").directory,playing:{template:"modules/playlistenchantment/templates/playlist/playing.hbs",templates:["modules/playlistenchantment/templates/playlist/sound-partial.hbs"]},footer:A(d,d,"PARTS").footer}),f(g,"defaultUploadPlaylistName","Playlistenchantment - Uploads");var h=class extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(t,e){super(),this.macroId=e,this.callingTarget=t}async _prepareContext(t){let e=await super._prepareContext(t),s=[];for(let n of ui.playlists._playing.context){let a=foundry.utils.duplicate(n),i=ui.playlists._playing.sounds.find(p=>p._id==a.id),r=foundry.audio.AudioHelper.volumeToInput(a.volume);a.pause.icon=`fa-solid ${i.playing&&!i.sound?.loaded?"fa-spinner fa-spin":"fa-pause"}`,a.lvolume=r,a.volumeTooltip=foundry.audio.AudioHelper.volumeToPercentage(r),a.currentTime=ui.playlists.constructor.formatTimestamp(i.playing?i.sound.currentTime:a.pausedTime),a.durationTime=ui.playlists.constructor.formatTimestamp(i.sound.duration),a.volume=n.volume,s.push(a)}return foundry.utils.mergeObject(e,{macroId:this.macroId,name:this.callingTarget.dataset.tooltip,isGM:game.user.isGM,playingSounds:s,showPlaying:ui.playlists.playing.length>0}),e}async _onRender(t,e){await super._onRender(t,e);let s=$(this.element);ui.playlists.activateListeners(s),s.find("[data-action]").on("click",async n=>{let a=n.currentTarget,i=a.dataset.action;if(i==="soundRepeat"){let{playlistId:r,soundId:p}=a.closest(".sound")?.dataset??{},l=game.playlists.get(r)?.sounds.get(p);await l?.update({repeat:!l?.repeat})}else{let{playlistId:r,soundId:p}=a.closest(".sound")?.dataset??{},l=game.playlists.get(r),m=l?.sounds.get(p);switch(a.dataset.action){case"soundPause":await m.update({playing:!1,pausedTime:m.sound.currentTime});break;case"soundPlay":await l.playSound(m);break;case"soundStop":await l.stopSound(m);break;default:let u=ui.playlists.options.actions[i];if(u){let y=[0];typeof u=="object"&&(y=u.buttons,u=u.handler),y.includes(n.button)&&await u?.call(ui.playlists,n,a)}}}}),s.find(".sound-volume").on("input",n=>{let a=n.currentTarget;ui.playlists._onSoundVolume(a),setTimeout(()=>{ui.playlists.render()},120)})}};c(h,"EnchantmentPopup"),f(h,"PARTS",{main:{root:!0,template:"modules/playlistenchantment/templates/currentplayling.hbs"}}),f(h,"DEFAULT_OPTIONS",{id:"enchantment-popup",window:{frame:!1},classes:["enchantmentplaylisttooltip","playlists-sidebar"]});var{mergeObject:V,getProperty:k}=foundry.utils;function H(){Hooks.on("hotbarDrop",(o,t,e)=>{if(["PlaylistSound","Playlist"].includes(t.type))return v(t.uuid,e),!1;if(t.type=="Folder"&&fromUuidSync(t.uuid).type=="Playlist")return v(t.uuid,e),!1}),Hooks.on("getPlaylistSoundContextOptions",(o,t)=>{t.push({name:"PLAYLISTENCHANTMENT.Prehear",icon:"<i class='fas fa-music'></i>",callback:e=>C(e)})}),Hooks.on("renderHotbar",(o,t)=>{t=$(t);let e=t.find(".slot.full");e.mouseenter(s=>x(s)),e.mouseleave(s=>S(s)),e.mousedown(s=>S(s))}),Hooks.on("preUpdatePlaylist",(o,t,e,s)=>{if(o.mode>=0&&"sounds"in t){let n=game.settings.get("playlistenchantment","settings");if(n.alwaysFade&&(t.fade=n.fadeModifier||0),n.normalize){let a=t.sounds.find(i=>i.playing);a&&(a.volume=n.normalizeModifier||0)}}}),Hooks.on("renderPlaylistDirectory",(o,t,e)=>{ui.enchantmentPopup?.render(!0)})}c(H,"setupHooks");async function v(o,t){let e=await fromUuid(o),s=`CONFIG.ui.playlists.hotbarPlaylist("${o}")`;U(s,e.name,"icons/svg/sound.svg",t,"Playlist")}c(v,"buildPlaylistMacro");function x(o){let t=o.currentTarget.dataset.slot,e=game.user.hotbar[t];if(!e)return;let s=game.macros.get(e);!s||!k(s,"flags.enchantedplaylist.type")||E(o,e)}c(x,"onHoverMacros");async function C(o){let t=o.dataset.playlistId,e=o.dataset.soundId,s=game.playlists.get(t).sounds.get(e),n=game.settings.get("playlistenchantment","settings"),a=n.normalize?n.normalizeModifier:s.volume||.5;ui.notifications.info(`Fetching & Playing ${s.name}`),foundry.audio.AudioHelper.play({src:s.path,volume:a,loop:!1},!1).then(i=>{new T(i,s).render(!0)})}c(C,"preHearSound");var I=class extends foundry.applications.api.HandlebarsApplicationMixin(foundry.applications.api.ApplicationV2){constructor(t,e){super(),this.sound=t,this.source=e,this.sound.addEventListener("stop",()=>{this.close()}),this.sound.addEventListener("end",()=>{this.close()})}async _prepareContext(t){let e=await super._prepareContext(t);return e.sound=this.sound,e.source=this.source,e}static _stopSound(t,e){this.close()}async close(t){return this.sound.stop(),super.close(t)}},T=I;c(T,"SoundPreview"),f(T,"PARTS",{main:{template:"modules/playlistenchantment/templates/soundpreview.hbs"}}),f(T,"DEFAULT_OPTIONS",{window:{title:"PLAYLISTENCHANTMENT.Prehear"},actions:{stopSound:I._stopSound}});async function E(o,t){$(".enchantment-popup").remove();let e=o.currentTarget,s=e.getBoundingClientRect(),n=new h(e,t);ui.enchantmentPopup=n,await n.render(!0);let a=$(n.element),i={left:s.x-135+s.width/2,top:s.y-a.height()};n.setPosition(i),$(o.currentTarget).off("mouseleave").on("mouseleave",r=>S(n)),a.on("mouseleave",r=>S(n)),game.tooltip.deactivate()}c(E,"showHotbarSoundMenu");function S(o){setTimeout(()=>{o?.element&&!$(o.element).is(":hover")&&o.close({animate:!1})},100)}c(S,"onUnhoverMacros");function U(o,t,e,s,n){let a=game.macros.contents.find(i=>i.name===t&&i.command===o);return a?game.user.assignHotbarMacro(a,s):Macro.create({name:t,type:"script",img:e,command:o,flags:{enchantedplaylist:{type:n}}},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,s)),!1}c(U,"createHotBarMacro");Hooks.once("init",()=>{game.settings.register("playlistenchantment","settings",{name:"playlistsettings",scope:"world",config:!1,default:{normalize:!1,normalizeModifier:.5,fadeModifier:500,alwaysFade:!1},type:Object}),game.settings.register("playlistenchantment","soundUploadFolder",{name:"PLAYLISTENCHANTMENT.soundUploadFolder",hint:"PLAYLISTENCHANTMENT.soundUploadFolderHint",scope:"world",config:!0,type:String,filePicker:"folder",default:"modules/playlistenchantment/storage"}),CONFIG.ui.playlists=g});Hooks.once("setup",()=>{H()});
