var S=Object.defineProperty;var A=(a,t,e)=>t in a?S(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var d=(a,t)=>S(a,"name",{value:t,configurable:!0});var I=(a,t,e)=>(A(a,typeof t!="symbol"?t+"":t,e),e);var{mergeObject:_}=foundry.utils,y=class extends PlaylistDirectory{static get defaultOptions(){let t=super.defaultOptions;return t.template="modules/playlistenchantment/templates/playlists-directory.html",t}async getData(t={}){let e=await super.getData(t),n=game.settings.get("playlistenchantment","settings");return _(e,{enchantment:n,normalizeModifier:foundry.audio.AudioHelper.volumeToInput(n.normalizeModifier),normalizeTooltip:PlaylistDirectory.volumeToTooltip(n.normalizeModifier),fadeTooltip:this.fadeTooltip(n.fadeModifier)}),e}activateListeners(t){super.activateListeners(t),t.find(".enchantment-volume-slider").change(this._onEnchantmentVolume.bind(this)),t.find(".enchanment-checkbox").change(this._onEnchantmentCheckbox.bind(this)),t.find(".enchantmentcontrol").click(this._onEnchantmentControl.bind(this)),t.find(".sound").dblclick(this._onEnchantmentSound.bind(this)),t.find(".sound-name").hover(e=>{e.currentTarget.scrollWidth>e.currentTarget.clientWidth&&(e.currentTarget.classList.add("marquee"),$(e.currentTarget).html(`<p>${e.currentTarget.textContent}</p>`))},e=>{$(e.currentTarget).html(e.currentTarget.textContent),e.currentTarget.classList.remove("marquee")})}_onEnchantmentSound(t){let e=game.playlists.get(t.currentTarget.dataset.playlistId),n=e.sounds.get(t.currentTarget.dataset.soundId);e.playSound(n)}fadeTooltip(t){return game.i18n.format("PLAYLISTENCHANTMENT.FadeTooltip",{value:t})}_onEnchantmentVolume(t){t.preventDefault();let e=t.currentTarget,n,s;return t.currentTarget.dataset.volume?(n=foundry.audio.AudioHelper.inputToVolume(e.value),s=PlaylistDirectory.volumeToTooltip(n)):t.currentTarget.dataset.unit&&(n=e.value,s=this.fadeTooltip(e.value)),e.setAttribute("data-tooltip",s),game.tooltip.activate(e,{text:s}),this.updatePlaylistEnchantment({[t.currentTarget.name]:n})}_onEnchantmentControl(t){let e=t.currentTarget.dataset.action;switch(e){case"play":this._enchantStartAll(t);break;case"stop":this._enchantStopAll();break;case"playlist-forward":case"playlist-backward":this._enchantAllSkip(e);break}}static async hotbarPlaylist(t){this.crossFade(t)}static async crossFade(t){let e=game.settings.get("playlistenchantment","settings"),n=e.fadeModifier,s=await fromUuid(t),o,i;if(s instanceof Playlist)o=s;else if(s instanceof PlaylistSound)i=s,o=i.parent;else if(s instanceof Folder){let l=s.contents;o=l[Math.floor(Math.random()*l.length)]}else return;let c=d(async(l,u,p)=>{p?await l.playSound(p):await l.playAll();let m=p||l.sounds.find(T=>T.playing);e.normalize&&m.updateSource({volume:e.normalizeModifier||.5});let h=m.volume||.5;m.sound.fade(h,{duration:u,from:0})},"fadeIn"),r=d((l,u,p=!0)=>{if(!l.playing)return;let m=l.sounds.find(T=>T.playing).sound;if(!m)return;let h=m.volume;m.fade(0,{duration:u,from:h}),p&&setTimeout(()=>l.stopAll(),u)},"fadeOut");if(!o){ui.notifications.error("Can't start Playlist - not found");return}if(!(!i&&ui.playlists._playingPlaylists.find(l=>l.id==o.id))){for(let l of ui.playlists._playingPlaylists)r(l,n,l.id!=o.id);c(o,n,i)}}_updateTimestamps(){super._updateTimestamps();for(let t of this._playingSounds){let e=$(".enchantmentplaylisttooltip")[0]?.querySelector(`.sound[data-sound-id="${t.id}"]`);if(!e)continue;let n=e.querySelector("span.current"),s=t.playing?t.sound.currentTime:t.pausedTime;n&&(n.textContent=this._formatTimestamp(s));let o=e.querySelector("span.duration");o&&(o.textContent=this._formatTimestamp(t.sound.duration));let i=e.querySelector("a.pause");i.classList.contains("fa-spinner")&&(i.classList.remove("fa-spin"),i.classList.replace("fa-spinner","fa-pause"))}}async _enchantStartAll(t){for(let e of this._playingSounds){let n=e.parent;n.mode>=0&&n.playSound(e)}if(this._playingSounds.length===0){let e=$(t.currentTarget).closest("[data-macro-id]")[0]?.dataset.macroId;e&&game.macros.get(e)?.execute()}}async _enchantAllSkip(t){for(let e of this._playingPlaylists)e.mode>=0&&e.playNext(void 0,{direction:t==="playlist-forward"?1:-1})}async _enchantStopAll(){for(let t of this._playingSounds)t.update({playing:!1,pausedTime:t.sound.currentTime})}async updatePlaylistEnchantment(t){let e=game.settings.get("playlistenchantment","settings");return _(e,t),await game.settings.set("playlistenchantment","settings",e)}_onEnchantmentCheckbox(t){let e={[t.currentTarget.name]:t.currentTarget.checked};return this.updatePlaylistEnchantment(e)}async _onDrop(t){t.preventDefault();let e=t.dataTransfer.files;if(e&&e.length>0){let n=Array.from(e).filter(s=>Object.keys(CONST.AUDIO_FILE_EXTENSIONS).includes(s.name.split(".").pop()));await this.handleAudioFilesUpload(t,n)}else super._onDrop(t)}isForge(){return typeof ForgeVTT<"u"&&ForgeVTT&&ForgeVTT.usingTheForge}findFilePicker(){return this.isForge()?ForgeVTT_FilePicker:FilePicker}async handleAudioFilesUpload(t,e){let n=game.settings.get("playlistenchantment","soundUploadFolder"),s=this.findFilePicker(),o=[];for(let r of e){let l=ui.notifications.info(game.i18n.format("PLAYLISTENCHANTMENT.uploading",{item:r.name}),{permanent:!0}),u=await s.upload("data",n,r);ui.notifications.remove(l);let p=r.name.split(".").slice(0,-1).join(".");o.push({name:p,path:u.path})}let i=this.getPlaylistIdFromElement(t.srcElement.closest(".playlist")),c=game.playlists.get(i);c||(c=game.playlists.find(r=>r.name===y.defaultUploadPlaylistName)),c||(c=await Playlist.create({name:y.defaultUploadPlaylistName,description:"Files uploaded by drag and drop",playing:!1})),c.createEmbeddedDocuments("PlaylistSound",o),ui.notifications.info(game.i18n.localize("PLAYLISTENCHANTMENT.uploadDone"))}getPlaylistIdFromElement(t){if(t==null)return!1;let e=t.classList.contains("playlist")?t:t.closest(".playlist");return e?e.dataset.documentId:(ui.notifications.error(game.i18n.localize("PLAYLISTENCHANTMENT.errorNoPlaylist")),!1)}},f=y;d(f,"EnchantedPlaylist"),I(f,"defaultUploadPlaylistName","Playlistenchantment - Uploads");var{mergeObject:F,getProperty:N}=foundry.utils;function b(){Hooks.on("hotbarDrop",(a,t,e)=>{if(["PlaylistSound","Playlist"].includes(t.type))return E(t.uuid,e),!1;if(t.type=="Folder"&&fromUuidSync(t.uuid).type=="Playlist")return E(t.uuid,e),!1}),Hooks.on("getEnchantedPlaylistSoundContext",(a,t)=>{t.push({name:"PLAYLISTENCHANTMENT.Prehear",icon:"<i class='fas fa-music'></i>",callback:e=>M(e)})}),Hooks.on("renderHotbar",(a,t)=>{let e=t.find(".macro.active");e.mouseenter(n=>k(n)),e.mouseleave(n=>P(n)),e.mousedown(n=>P(n))}),Hooks.on("preUpdatePlaylist",(a,t,e,n)=>{if(a.mode>=0&&"sounds"in t){let s={},o=game.settings.get("playlistenchantment","settings");if(o.alwaysFade&&(s.fade=o.fadeModifier||0),o.normalize){let i=t.sounds.find(c=>c.playing);if(!i)return;i.volume=o.normalizeModifier||0,s.sounds=[i]}Object.keys(s).length>0&&a.updateSource(s)}})}d(b,"setupHooks");async function E(a,t){let e=await fromUuid(a),n=`CONFIG.ui.playlists.hotbarPlaylist("${a}")`;L(n,e.name,"icons/svg/sound.svg",t,"Playlist")}d(E,"buildPlaylistMacro");function k(a){let t=game.macros.get(a.currentTarget.dataset.macroId);!t||!N(t,"flags.enchantedplaylist.type")||H(a)}d(k,"onHoverMacros");async function M(a){let t=a[0].dataset.playlistId,e=a[0].dataset.soundId,n=game.playlists.get(t).sounds.get(e),s=game.settings.get("playlistenchantment","settings"),o=s.normalize?s.normalizeModifier:n.volume||.5;ui.notifications.info(`Fetching & Playing ${n.name}`),foundry.audio.AudioHelper.play({src:n.path,volume:o,loop:!1},!1).then(i=>{new g(i,n).render(!0)})}d(M,"preHearSound");var g=class extends Application{static get defaultOptions(){return F(super.defaultOptions,{template:"modules/playlistenchantment/templates/soundpreview.html"})}constructor(t,e){super(),this.sound=t,this.source=e,this.sound.addEventListener("stop",()=>{this.close()}),this.sound.addEventListener("end",()=>{this.close()})}async getData(){let t=await super.getData();return t.sound=this.sound,t.source=this.source,t}activateListeners(t){t.find(".stopSound").click(()=>this.close())}async close(t){return this.sound.stop(),super.close(t)}};d(g,"SoundPreview");async function H(a){let t=".enchantmentplaylisttooltip";$(t).remove();let e=a.currentTarget.getBoundingClientRect(),n=a.currentTarget.dataset.tooltip,s=foundry.utils.duplicate(ui.playlists._playingSoundsData);for(let r of s){let l=ui.playlists._playingSounds.find(u=>u._id==r._id);r.pauseIcon=ui.playlists._getPauseIcon(l),r.lvolume=foundry.audio.AudioHelper.volumeToInput(r.volume),r.volumeTooltip=ui.playlists.constructor.volumeToTooltip(r.volume),r.currentTime=ui.playlists._formatTimestamp(l.playing?l.sound.currentTime:r.pausedTime),r.durationTime=ui.playlists._formatTimestamp(l.sound.duration)}let o={macroId:a.currentTarget.dataset.macroId,name:n,isGM:game.user.isGM,playingSounds:s,showPlaying:ui.playlists._playingSoundsData.length>0},i=$(await renderTemplate("modules/playlistenchantment/templates/currentplayling.html",o));ui.playlists.activateListeners(i),$("body").append(i);let c=$(`.enchantmentplaylisttooltip[data-macro-id="${a.currentTarget.dataset.macroId}"]`);c.on("mouseleave",r=>P(r)),c.css({left:e.x-125+e.width/2,top:e.y-c.height(),zIndex:1e3}),c.fadeIn(),game.tooltip.deactivate()}d(H,"showHotbarSoundMenu");function P(a){let t=`.enchantmentplaylisttooltip[data-macro-id="${a.currentTarget.dataset.macroId}"]`;setTimeout(()=>{$(`${t}:hover`).length||$(t).remove()},100)}d(P,"onUnhoverMacros");function L(a,t,e,n,s){let o=game.macros.contents.find(i=>i.name===t&&i.command===a);return o?game.user.assignHotbarMacro(o,n):Macro.create({name:t,type:"script",img:e,command:a,flags:{enchantedplaylist:{type:s}}},{displaySheet:!1}).then(i=>game.user.assignHotbarMacro(i,n)),!1}d(L,"createHotBarMacro");Hooks.once("init",()=>{game.settings.register("playlistenchantment","settings",{name:"playlistsettings",scope:"world",config:!1,default:{normalize:!1,normalizeModifier:.5,fadeModifier:500,alwaysFade:!1},type:Object}),game.settings.register("playlistenchantment","soundUploadFolder",{name:"PLAYLISTENCHANTMENT.soundUploadFolder",hint:"PLAYLISTENCHANTMENT.soundUploadFolderHint",scope:"world",config:!0,type:String,filePicker:"folder",default:"modules/playlistenchantment/storage"}),CONFIG.ui.playlists=f});Hooks.once("setup",()=>{b()});
